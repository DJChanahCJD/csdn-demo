{% extends 'base.html' %}
{% block title %} 首页 {% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4" data-aos="fade-right">
    <div>
        <h1 class="display-5 fw-bold text-primary mb-2">
            <i class="fas fa-newspaper me-3"></i>博客列表
        </h1>
        <p class="text-muted">发现精彩内容，分享知识见解</p>
    </div>
    <div class="d-flex align-items-center gap-3">
        <select class="form-select form-select-lg" id="category" name="category" style="min-width: 200px;">
            <option value="">🏷️ 请选择分类</option>
        </select>
        <button class="btn btn-outline-primary" onclick="loadBlogs('', 1)">
            <i class="fas fa-sync-alt me-1"></i>刷新
        </button>
    </div>
</div>

<div id="blog-list" class="row g-4" data-aos="fade-up" data-aos-delay="200">
    <div id="loading" class="col-12 text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
        <p class="mt-3 text-muted">正在加载精彩内容...</p>
    </div>
</div>

<div id="pagination" class="d-flex justify-content-center mt-5" data-aos="fade-up" data-aos-delay="400"></div>

<script>
$(document).ready(function () {
    const $categoryEl = $("#category");
    const $listEl = $("#blog-list");
    const $loadingEl = $("#loading");

    let currentPage = 1;
    let totalPages = 1;
    let totalItems = 0;
    let currentCategoryId = "";

    $listEl.after('<div id="pagination" class="d-flex justify-content-center mt-4"></div>');
    const $paginationEl = $("#pagination");

    function formatDate(s) {
        try {
            return new Date(s).toLocaleString('zh-CN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch {
            return "";
        }
    }

    function cardHtml(b) {
        const avatar = b.author_avatar || "/static/img/avatar.jpg";
        const detailUrl = "/blog/" + b.id + "/";
        const categoryName = b.category_name || (b.category && b.category.name) || "";
        const authorName = b.author_username || b.author || "";
        
        return `
            <div class="col-md-6" data-aos="fade-up" data-aos-delay="100">
                <div class="card blog-card h-100">
                    <div class="card-header">
                        <a href="${detailUrl}">
                            <i class="fas fa-file-alt me-2"></i>${b.title}
                        </a>
                    </div>
                    <div class="card-body">
                        <p class="card-text">${(b.content || "").replace(/<[^>]*>/g, "").slice(0, 150)}...</p>
                    </div>
                    <div class="card-footer d-flex justify-content-between align-items-center">
                        <a href="{% url 'user:my' %}?user_name=${authorName}" class="author-info">
                            <img src="${avatar}" alt="avatar" class="author-avatar">
                            <span>${authorName}</span>
                        </a>
                        <div class="d-flex align-items-center gap-2">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>${formatDate(b.pub_time)}
                            </small>
                            ${categoryName ? `<span class="category-badge">${categoryName}</span>` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function renderBlogs(items) {
        if (!items || items.length === 0) {
            $listEl.html(`
                <div class="col-12">
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>暂无内容</h3>
                        <p>还没有发布任何博客，快去创作第一篇吧！</p>
                        <a href="{% url 'blog:pub_blog' %}" class="btn btn-primary btn-lg">
                            <i class="fas fa-plus me-2"></i>发布博客
                        </a>
                    </div>
                </div>
            `);
            return;
        }
        $listEl.html(items.map(cardHtml).join(""));
        AOS.refresh(); // 刷新AOS动画
    }

    function renderPagination() {
        if (totalPages <= 1) {
            $paginationEl.empty();
            return;
        }

        let paginationHtml = '<nav aria-label="Page navigation"><ul class="pagination pagination-lg">';

        // 上一页
        if (currentPage > 1) {
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" data-page="${currentPage - 1}">
                <i class="fas fa-chevron-left me-1"></i>上一页
            </a></li>`;
        }

        // 页码
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, currentPage + 2);

        if (startPage > 1) {
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>`;
            if (startPage > 2) {
                paginationHtml += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            if (i === currentPage) {
                paginationHtml += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
            } else {
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
            }
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                paginationHtml += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a></li>`;
        }

        // 下一页
        if (currentPage < totalPages) {
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" data-page="${currentPage + 1}">
                下一页<i class="fas fa-chevron-right ms-1"></i>
            </a></li>`;
        }

        paginationHtml += "</ul></nav>";
        paginationHtml += `<div class="text-center mt-3">
            <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                共 ${totalItems} 条记录，第 ${currentPage} 页，共 ${totalPages} 页
            </small>
        </div>`;

        $paginationEl.html(paginationHtml);

        $paginationEl.find(".page-link").on("click", function (e) {
            e.preventDefault();
            const page = $(this).data("page");
            if (page) {
                loadBlogs(currentCategoryId, page);
            }
        });
    }

    function searchBlogs(query, page = 1) {
        $loadingEl.show();
        currentCategoryId = "";
        currentPage = page;

        $.get({
            url: "/api/blogs/search/?q=" + encodeURIComponent(query) + "&page=" + page,
            dataType: "json",
            headers: { Accept: "application/json" },
        })
        .done(function (data) {
            if (data.results) {
                renderBlogs(data.results);
                totalItems = data.count;
                totalPages = Math.ceil(totalItems / 4);
                renderPagination();
            } else {
                renderBlogs(data);
                $paginationEl.empty();
            }
        })
        .fail(function (jqXHR, textStatus, errorThrown) {
            $listEl.html(`
                <div class="col-12">
                    <div class="alert alert-danger text-center">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        搜索失败：${errorThrown}
                    </div>
                </div>
            `);
        })
        .always(function () {
            $loadingEl.hide();
        });
    }

    function loadCategories() {
        return $.getJSON("/api/categories/")
            .done(function (data) {
                const items = Array.isArray(data) ? data : data.results || [];
                $categoryEl.html(
                    '<option value="">🏷️ 请选择分类</option>' +
                    items.map((c) => `<option value="${c.id}">${c.name}</option>`).join("")
                );
            })
            .fail(function () {
                console.error("Failed to load categories");
            });
    }

    function loadBlogs(categoryId, page = 1) {
        $loadingEl.show();
        currentCategoryId = categoryId;
        currentPage = page;

        let url = categoryId
            ? "/api/blogs/by-category/?category_id=" + encodeURIComponent(categoryId) + "&page=" + page
            : "/api/blogs/?page=" + page;

        $.get({
            url: url,
            dataType: "json",
            headers: { Accept: "application/json" },
        })
        .done(function (data) {
            if (data.results) {
                renderBlogs(data.results);
                totalItems = data.count;
                totalPages = Math.ceil(totalItems / 4);
                renderPagination();
            } else {
                renderBlogs(data);
                $paginationEl.empty();
            }
        })
        .fail(function (jqXHR, textStatus, errorThrown) {
            $listEl.html(`
                <div class="col-12">
                    <div class="alert alert-danger text-center">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        加载失败：${errorThrown}
                    </div>
                </div>
            `);
        })
        .always(function () {
            $loadingEl.hide();
        });
    }

    $categoryEl.on("change", function () {
        loadBlogs($(this).val(), 1);
    });

    // 搜索功能处理
    $("#search-form").on("submit", function (e) {
        e.preventDefault();
        const query = $("#search-input").val().trim();
        if (query) {
            searchBlogs(query, 1);
        }
    });

    loadCategories().then(function () {
        loadBlogs("", 1);
    });
});
</script>

<style>
.blog-card {
    transition: all 0.3s ease;
    border: none;
    border-radius: 20px;
    overflow: hidden;
    background: white;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.blog-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.blog-card .card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    padding: 1.5rem;
}

.blog-card .card-header a {
    color: white;
    text-decoration: none;
    font-weight: 600;
    font-size: 1.1rem;
    display: block;
    transition: all 0.3s ease;
}

.blog-card .card-header a:hover {
    color: rgba(255, 255, 255, 0.9);
    transform: translateX(5px);
}

.blog-card .card-body {
    padding: 1.5rem;
    background: white;
    color: #64748b;
    line-height: 1.6;
}

.blog-card .card-footer {
    background: #f8fafc;
    border: none;
    padding: 1rem 1.5rem;
}

.author-info {
    display: flex;
    align-items: center;
    text-decoration: none;
    color: #64748b;
    transition: all 0.3s ease;
}

.author-info:hover {
    color: #2563eb;
    transform: translateX(3px);
}

.author-avatar {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    margin-right: 0.75rem;
}

.category-badge {
    background: linear-gradient(45deg, #2563eb, #8b5cf6);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 50px;
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.3s ease;
}

.category-badge:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    color: white;
}

.pagination .page-link {
    border: none;
    border-radius: 10px;
    margin: 0 0.25rem;
    padding: 0.75rem 1rem;
    color: #64748b;
    font-weight: 500;
    transition: all 0.3s ease;
}

.pagination .page-link:hover {
    background: #2563eb;
    color: white;
    transform: translateY(-2px);
}

.pagination .page-item.active .page-link {
    background: linear-gradient(45deg, #2563eb, #8b5cf6);
    border: none;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #64748b;
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}
</style>
{% endblock %}
